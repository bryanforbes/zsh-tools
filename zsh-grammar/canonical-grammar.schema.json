{
  "$schema": "https://json-schema.org/draft-07/schema",
  "title": "ZshGrammar",
  "definitions": {
    "Metadata": {
      "type": "object",
      "properties": {
        "description": {
          "type": "string",
          "description": "What this rule or symbol represents"
        },
        "source": {
          "type": "object",
          "required": ["file", "line"],
          "properties": {
            "file": { "type": "string", "description": "e.g., parse.c" },
            "line": { "type": "integer" },
            "function": {
              "type": "string",
              "description": "e.g., par_cmd"
            },
            "context": {
              "type": "string",
              "description": "e.g., switch case FOR"
            }
          },
          "additionalProperties": false
        }
      }
    },
    "Empty": {
      "type": "object",
      "const": { "empty": true }
    },
    "Optional": {
      "type": "object",
      "required": ["optional"],
      "properties": {
        "optional": { "$ref": "#/definitions/Rule" }
      },
      "description": "Optional node"
    },
    "Condition": {
      "oneOf": [
        {
          "type": "object",
          "required": ["option"],
          "properties": {
            "option": { "type": "string" }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["parseflag"],
          "properties": {
            "parseflag": {
              "type": "string",
              "enum": [
                "incmdpos",
                "incond",
                "inredir",
                "incasepat",
                "infor",
                "inrepeat",
                "intypeset",
                "isnewlin"
              ]
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["lexstate"],
          "properties": {
            "lexstate": {
              "type": "string",
              "enum": [
                "INCMDPOS",
                "INCOND",
                "INREDIR",
                "INCASEPAT",
                "INFOR",
                "INREPEAT",
                "INTYPESET",
                "ISNEWLIN",
                "IN_MATH",
                "ALIASSPACEFLAG",
                "INCOMPARISON",
                "IN_ARRAY",
                "IN_SUBSTITUTION",
                "IN_BRACEEXP",
                "IN_GLOBPAT"
              ]
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "sinceVersion": { "type": "string" },
            "untilVersion": { "type": "string" }
          },
          "minProperties": 1,
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["not"],
          "properties": {
            "not": { "$ref": "#/definitions/Condition" }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["and"],
          "properties": {
            "and": {
              "type": "array",
              "items": { "$ref": "#/definitions/Condition" },
              "minItems": 2
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["or"],
          "properties": {
            "or": {
              "type": "array",
              "items": { "$ref": "#/definitions/Condition" },
              "minItems": 2
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "Variant": {
      "type": "object",
      "required": ["variant", "condition"],
      "properties": {
        "variant": { "$ref": "#/definitions/Rule" },
        "condition": { "$ref": "#/definitions/Condition" }
      },
      "description": "Variant path based on options"
    },
    "Terminal": {
      "type": "object",
      "required": ["pattern"],
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Regex pattern for unnamed terminal (identifier, number, etc.)",
          "format": "regex"
        }
      }
    },
    "Union": {
      "type": "object",
      "required": ["union"],
      "properties": {
        "union": {
          "type": "array",
          "items": { "$ref": "#/definitions/Rule" },
          "minItems": 2
        }
      }
    },
    "Sequence": {
      "type": "object",
      "required": ["sequence"],
      "properties": {
        "sequence": {
          "type": "array",
          "items": { "$ref": "#/definitions/Rule" },
          "minItems": 2
        }
      }
    },
    "Repeat": {
      "type": "object",
      "required": ["repeat"],
      "properties": {
        "repeat": { "$ref": "#/definitions/Rule" },
        "min": {
          "type": "integer",
          "default": 0,
          "description": "Minimum repetitions (0 for *, 1 for +; must validate min <= max externally)"
        },
        "max": {
          "type": "integer",
          "description": "Maximum repetitions (omit for unbounded)"
        }
      }
    },
    "Reference": {
      "type": "object",
      "oneOf": [
        {
          "type": "object",
          "description": "Token reference looked up in the current language's \"tokens\" key",
          "required": ["$token"],
          "properties": {
            "$token": {
              "type": "string",
              "pattern": "^[A-Z][A-Z0-9_]*$",
              "description": "Token names in SCREAMING_SNAKE_CASE (e.g., FOR, WORD)"
            }
          }
        },
        {
          "type": "object",
          "description": "Rule reference looked up in a language's \"rules\" key",
          "required": ["$rule"],
          "properties": {
            "$rule": {
              "type": "string",
              "pattern": "^[a-z][a-z0-9_]*$",
              "description": "Rule names in lower_snake_case (e.g., for, while, case)"
            },
            "$lang": {
              "type": "string",
              "pattern": "^[a-z][a-zA-Z0-9_]*$",
              "description": "The language to look the rule up in; if omitted, look up in the current language"
            }
          }
        }
      ]
    },
    "Rule": {
      "allOf": [
        {
          "oneOf": [
            { "$ref": "#/definitions/Empty" },
            { "$ref": "#/definitions/Optional" },
            { "$ref": "#/definitions/Reference" },
            { "$ref": "#/definitions/Repeat" },
            { "$ref": "#/definitions/Sequence" },
            { "$ref": "#/definitions/Terminal" },
            { "$ref": "#/definitions/Union" },
            { "$ref": "#/definitions/Variant" }
          ]
        },
        { "$ref": "#/definitions/Metadata" }
      ]
    },
    "RuleMap": {
      "type": "object",
      "minProperties": 1,
      "propertyNames": {
        "pattern": "^[a-z][a-z0-9_]*$",
        "description": "Rule names in lower_snake_case (e.g., for, while, case)"
      },
      "additionalProperties": { "$ref": "#/definitions/Rule" }
    },
    "Token": {
      "allOf": [
        {
          "oneOf": [
            {
              "type": "object",
              "required": ["matches"],
              "properties": {
                "matches": {
                  "oneOf": [
                    { "type": "string", "description": "Single string match" },
                    {
                      "type": "array",
                      "items": { "type": "string" },
                      "minItems": 2,
                      "description": "Multiple string matches (eg. declare, export, and float all produce TYPESET)"
                    }
                  ]
                }
              }
            },
            { "$ref": "#/definitions/Terminal" }
          ]
        },
        { "$ref": "#/definitions/Metadata" }
      ]
    },
    "TokenMap": {
      "type": "object",
      "minProperties": 1,
      "propertyNames": {
        "pattern": "^[A-Z][A-Z0-9_]*$",
        "description": "Token names in SCREAMING_SNAKE_CASE (e.g., FOR, WORD)"
      },
      "additionalProperties": { "$ref": "#/definitions/Token" }
    },
    "Language": {
      "type": "object",
      "properties": {
        "rules": { "$ref": "#/definitions/RuleMap" },
        "tokens": { "$ref": "#/definitions/TokenMap" }
      },
      "additionalProperties": false
    }
  },
  "type": "object",
  "required": ["languages"],
  "properties": {
    "languages": {
      "type": "object",
      "required": ["core"],
      "properties": {
        "core": { "$ref": "#/definitions/Language" }
      },
      "propertyNames": {
        "pattern": "^[a-z][a-zA-Z0-9_]*$",
        "description": "Language names must start with lowercase and contain only letters, digits, or underscore"
      },
      "additionalProperties": { "$ref": "#/definitions/Language" }
    },
    "version": { "type": "string" },
    "zsh_version": { "type": "string" },
    "zsh_revision": { "type": "string" },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of when the schema was generated"
    }
  }
}
